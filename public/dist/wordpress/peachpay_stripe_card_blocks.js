!function(){"use strict";var e={465:function(e,t,n){n.d(t,{J:function(){return c}});var r="https://js.stripe.com/v3",a=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,s="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",o=null,u=Promise.resolve().then((function(){return e=null,null!==o||(o=new Promise((function(t,n){if("undefined"!=typeof window&&"undefined"!=typeof document)if(window.Stripe&&e&&console.warn(s),window.Stripe)t(window.Stripe);else try{var o=function(){for(var e=document.querySelectorAll('script[src^="'.concat(r,'"]')),t=0;t<e.length;t++){var n=e[t];if(a.test(n.src))return n}return null}();o&&e?console.warn(s):o||(o=function(e){var t=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",n=document.createElement("script");n.src="".concat(r).concat(t);var a=document.head||document.body;if(!a)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return a.appendChild(n),n}(e)),o.addEventListener("load",(function(){window.Stripe?t(window.Stripe):n(new Error("Stripe.js not available"))})),o.addEventListener("error",(function(){n(new Error("Failed to load Stripe.js"))}))}catch(e){return void n(e)}else t(null)}))),o;var e})),i=!1;u.catch((function(e){i||console.warn(e)}));var c=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];i=!0;var r=Date.now();return u.then((function(e){return function(e,t,n){if(null===e)return null;var r=e.apply(void 0,t);return function(e,t){e&&e._registerWrapper&&e._registerWrapper({name:"stripe-js",version:"2.2.0",startTime:t})}(r,n),r}(e,t,r)}))}},127:function(e,t,n){n.d(t,{Z:function(){return s}});var r=n(86),a=n(412);function s(e){return e.currency?(0,r.createElement)("div",{style:{display:"flex",flexDirection:"column"}},(0,r.createElement)("p",{style:{textAlign:"justify",margin:"0.5rem 0 0",fontSize:"smaller"}},e.name," does not support the currency you currently have chosen. ",(0,r.createElement)("b",null,"Update to ",e.currency)," below to use this payment method."),(0,r.createElement)("button",{type:"button",className:"button currency-fallback-button",style:{fontSize:"smaller",marginBottom:"16px"},onClick:function(){e.currency&&((0,a.k)(e.currency),window.location.reload())}},"Update to ",e.currency)):null}},583:function(e,t,n){n.d(t,{Jb:function(){return c},Nm:function(){return f},Rp:function(){return l}});var r=n(861),a=n(284),s=n.n(a),o=n(465),u=n(877),i=n(22),c=function(){var e=(0,r.Z)(s().mark((function e(t,n){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){try{e((0,o.J)(t,{locale:"auto",stripeAccount:n}))}catch(t){e(t.message)}})));case 1:case"end":return e.stop()}}),e)})));return function(_x,t){return e.apply(this,arguments)}}(),p=i.z.object({setup_intent_details:i.z.object({client_secret:i.z.string()})});function l(e){return d.apply(this,arguments)}function d(){return(d=(0,r.Z)(s().mark((function e(t){var n,r,a,o,i;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=new FormData).append("security",t.setup_intent_nonce),n.append("payment_method_type",t.payment_method_type),n.append("payment_method",t.payment_method_ID),e.next=6,(0,u.Fi)(t.setup_intent_url,{method:"POST",body:n});case 6:if(r=e.sent,a=r.error,o=r.result,!a&&null!=o&&o.data){e.next=11;break}return e.abrupt("return",null);case 11:if((i=p.safeParse(o.data)).success){e.next=14;break}return e.abrupt("return",null);case 14:return e.abrupt("return",i.data);case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function f(e){var t,n=i.z.object({data:i.z.object({client_secret:i.z.string()}),success_url:i.z.string()});try{t=JSON.parse(atob(decodeURIComponent(e)))}catch(e){return console.error(e),null}var r=n.safeParse(t);return r.success?r.data:(console.error(r.error),null)}},412:function(e,t,n){function r(e){document.cookie=`pp_active_currency=${e};path=/`}n.d(t,{k:function(){return r}})},906:function(e,t,n){function r(e){return function(e){if(function(e){return"object"==typeof e&&null!==e&&"message"in e&&"string"==typeof e.message}(e))return e;try{return new Error(JSON.stringify(e))}catch(t){return new Error(String(e))}}(e).message}n.d(t,{e:function(){return r}})},877:function(e,t,n){n.d(t,{Fi:function(){return o}});var r=n(861),a=n(284),s=n.n(a);function o(e,t){return u.apply(this,arguments)}function u(){return u=(0,r.Z)(s().mark((function e(t,n){var a,o=arguments;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=o.length>2&&void 0!==o[2]?o[2]:/\{\s*"[\s\S]*[^{}]*\}/g,e.abrupt("return",fetch(t,n).then(function(){var e=(0,r.Z)(s().mark((function e(t){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.text());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).then((function(e){try{return{result:JSON.parse(e)}}catch(n){var t=a.exec(e);return null!==t&&t[0]?(console.log("Fixed malformed JSON. Original:"),console.log(e),{result:JSON.parse(t[0])}):(console.log("Unable to fix malformed JSON"),{error:n})}})).catch((function(e){return{error:e}})));case 2:case"end":return e.stop()}}),e)}))),u.apply(this,arguments)}},86:function(e){e.exports=window.React},284:function(e){e.exports=window.regeneratorRuntime},22:function(e){e.exports=window.peachpay_checkout_blocks},613:function(e){e.exports=window.wc.wcBlocksRegistry},617:function(e){e.exports=window.wc.wcSettings},907:function(e,t,n){function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}n.d(t,{Z:function(){return r}})},878:function(e,t,n){function r(e){if(Array.isArray(e))return e}n.d(t,{Z:function(){return r}})},861:function(e,t,n){function r(e,t,n,r,a,s,o){try{var u=e[s](o),i=u.value}catch(e){return void n(e)}u.done?t(i):Promise.resolve(i).then(r,a)}function a(e){return function(){var t=this,n=arguments;return new Promise((function(a,s){var o=e.apply(t,n);function u(e){r(o,a,s,u,i,"next",e)}function i(e){r(o,a,s,u,i,"throw",e)}u(void 0)}))}}n.d(t,{Z:function(){return a}})},902:function(e,t,n){function r(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,a,s,o,u=[],i=!0,c=!1;try{if(s=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;i=!1}else for(;!(i=(r=s.call(n)).done)&&(u.push(r.value),u.length!==t);i=!0);}catch(e){c=!0,a=e}finally{try{if(!i&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(c)throw a}}return u}}n.d(t,{Z:function(){return r}})},267:function(e,t,n){function r(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}n.d(t,{Z:function(){return r}})},324:function(e,t,n){n.d(t,{Z:function(){return u}});var r=n(878),a=n(902),s=n(181),o=n(267);function u(e,t){return(0,r.Z)(e)||(0,a.Z)(e,t)||(0,s.Z)(e,t)||(0,o.Z)()}},181:function(e,t,n){n.d(t,{Z:function(){return a}});var r=n(907);function a(e,t){if(e){if("string"==typeof e)return(0,r.Z)(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?(0,r.Z)(e,t):void 0}}}},t={};function n(r){var a=t[r];if(void 0!==a)return a.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,n),s.exports}n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,{a:t}),t},n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){var e=n(324),t=n(861),r=n(86),a=n(284),s=n.n(a),o=n(613),u=n(617),i=n(583),c=n(22),p=n(127),l=n(906),d=c.z.object({title:c.z.string(),description:c.z.string(),supports:c.z.string().array(),connect_id:c.z.string(),public_key:c.z.string(),setup_intent_url:c.z.string(),setup_intent_nonce:c.z.string(),currency_fallback_required:c.z.union([c.z.string(),c.z.null()])}).safeParse((0,u.getSetting)("peachpay_stripe_card_data",!1));if(!d.success)throw console.error(d.error),new Error("PeachPay Stripe Card data is not available");var f=d.data;(0,i.Jb)(f.public_key,f.connect_id).then((function(n){if(null===n)throw new Error("Stripe is null");if("string"==typeof n)throw new Error(n);var a=n.elements().create("card",{style:{base:{color:"#333",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#6a6a6a"}}},hidePostalCode:!0}),u=function(o){var u=o.emitResponse,d=o.eventRegistration,m=o.billing,y=d.onPaymentSetup,h=d.onCheckoutSuccess,v=d.onCheckoutFail,b=(0,r.useRef)(null),g=(0,r.useRef)(null);return(0,r.useEffect)((function(){g.current&&(b.current=a,g.current.innerHTML="",b.current.mount(g.current))}),[]),(0,r.useEffect)((function(){return y((0,t.Z)(s().mark((function e(){var t,r,o,p,d,y,h,v,b;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,c.startTransaction)("peachpay_stripe_card");case 3:if(!(t=e.sent).error){e.next=6;break}return e.abrupt("return",{type:u.responseTypes.ERROR,message:(0,l.e)(t.error)});case 6:if(void 0!==t.result){e.next=8;break}return e.abrupt("return",{type:u.responseTypes.ERROR,message:"Missing transaction ID"});case 8:return r=t.result,e.next=11,n.createPaymentMethod({type:"card",card:a,billing_details:{address:{city:m.billingAddress.city,country:m.billingAddress.country,line1:m.billingAddress.address_1,line2:m.billingAddress.address_2,postal_code:m.billingAddress.postcode,state:m.billingAddress.state},email:m.billingAddress.email,name:m.billingAddress.first_name+" "+m.billingAddress.last_name,phone:m.billingAddress.phone}});case 11:if(!(o=e.sent).error){e.next=15;break}return console.error(o.error),e.abrupt("return",{type:u.responseTypes.ERROR,message:null!==(p=o.error.message)&&void 0!==p?p:"Failed to tokenize payment method."});case 15:if(!(m.cartTotal.value>0)){e.next=17;break}return e.abrupt("return",{type:u.responseTypes.SUCCESS,meta:{paymentMethodData:{peachpay_transaction_id:r,peachpay_stripe_payment_method_id:o.paymentMethod.id}}});case 17:return e.next=19,(0,i.Rp)({payment_method_type:"card",payment_method_ID:o.paymentMethod.id,setup_intent_url:f.setup_intent_url,setup_intent_nonce:f.setup_intent_nonce});case 19:if(null!==(d=e.sent)){e.next=22;break}return e.abrupt("return",{type:u.responseTypes.ERROR,message:"Failed to create setup intent."});case 22:return e.next=24,n.confirmCardSetup(d.setup_intent_details.client_secret);case 24:if(y=e.sent,h=y.error,v=y.setupIntent,!h){e.next=29;break}return e.abrupt("return",{type:u.responseTypes.ERROR,message:null!==(b=h.message)&&void 0!==b?b:"Failed to confirm setup intent."});case 29:if("succeeded"===v.status){e.next=31;break}return e.abrupt("return",{type:u.responseTypes.ERROR,message:`Setup intent resulted in invalid status (${v.status})`});case 31:if("object"!=typeof v.payment_method&&null!==v.payment_method){e.next=33;break}return e.abrupt("return",{type:u.responseTypes.ERROR,message:`Payment method invalid type: (${typeof v.payment_method})`});case 33:return e.abrupt("return",{type:u.responseTypes.SUCCESS,meta:{paymentMethodData:{peachpay_transaction_id:r,peachpay_stripe_payment_method_id:v.payment_method}}});case 36:return e.prev=36,e.t0=e.catch(0),e.abrupt("return",{type:u.responseTypes.ERROR,message:e.t0.message});case 39:case"end":return e.stop()}}),e,null,[[0,36]])}))))}),[o,y]),(0,r.useEffect)((function(){var r=h(function(){var r=(0,t.Z)(s().mark((function t(r){var a,o,c,p,l,d,f,m,y,h,v,b,g,_,w,x;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=new URL(r.redirectUrl),o=a.hash.split("="),c=(0,e.Z)(o,2),p=c[0],l=c[1],""!==a.hash&&"#payment_data"===p&&l){t.next=4;break}return t.abrupt("return");case 4:if(null!==(d=(0,i.Nm)(l))){t.next=7;break}return t.abrupt("return",{type:u.responseTypes.ERROR,message:"Failed to parse payment data"});case 7:return f=d.data.client_secret,m=d.success_url,t.next=11,n.retrievePaymentIntent(f);case 11:if(y=t.sent,h=y.paymentIntent,!(v=y.error)){t.next=16;break}return t.abrupt("return",{type:u.responseTypes.ERROR,message:null!==(b=null==v?void 0:v.message)&&void 0!==b?b:"Failed to retrieve payment intent.",messageContext:u.noticeContexts.PAYMENTS});case 16:if("succeeded"!==h.status&&"requires_capture"!==h.status){t.next=18;break}return t.abrupt("return",{type:u.responseTypes.SUCCESS,redirectUrl:m});case 18:if("requires_action"!==h.status){t.next=29;break}return t.next=21,n.confirmCardPayment(f);case 21:if(g=t.sent,_=g.paymentIntent,!(w=g.error)){t.next=26;break}return t.abrupt("return",{type:u.responseTypes.ERROR,message:null!==(x=null==w?void 0:w.message)&&void 0!==x?x:"Failed to confirm payment intent.",messageContext:u.noticeContexts.PAYMENTS});case 26:if("succeeded"!==_.status&&"requires_capture"!==_.status){t.next=28;break}return t.abrupt("return",{type:u.responseTypes.SUCCESS,redirectUrl:m});case 28:return t.abrupt("return",{type:u.responseTypes.ERROR,message:`Confirmed payment intent invalid status: ${_.status}`,messageContext:u.noticeContexts.PAYMENTS});case 29:return t.abrupt("return",{type:u.responseTypes.ERROR,message:`Failed to confirm payment intent with status: ${h.status}`,messageContext:u.noticeContexts.PAYMENTS});case 30:case"end":return t.stop()}}),t)})));return function(_x){return r.apply(this,arguments)}}());return r}),[o,h]),(0,r.useEffect)((function(){return v((function(e){var t,n,r;return(null===(t=e.processingResponse)||void 0===t?void 0:t.paymentStatus)===u.responseTypes.FAIL?{type:u.responseTypes.FAIL,message:e.processingResponse.paymentDetails.message,messageContext:u.noticeContexts.PAYMENTS}:{type:u.responseTypes.FAIL,message:null!==(n=null===(r=e.processingResponse)||void 0===r?void 0:r.message)&&void 0!==n?n:`Checkout failed unexpectedly ${JSON.stringify(e)}`,messageContext:u.noticeContexts.PAYMENTS}}))}),[o,v]),f.currency_fallback_required?(0,r.createElement)("div",null,(0,r.createElement)(p.Z,{name:f.title,currency:f.currency_fallback_required})):(0,r.createElement)("div",null,(0,r.createElement)("div",{style:{marginBottom:"0.5rem"}},f.description),(0,r.createElement)("div",{ref:g},"Loading..."))};(0,o.registerPaymentMethod)({ariaLabel:f.title,canMakePayment(e){return e.paymentMethods.includes("peachpay_stripe_card")},content:(0,r.createElement)(u,null),edit:(0,r.createElement)(u,null),label:(0,r.createElement)((function(e){var t=e.components.PaymentMethodLabel;return(0,r.createElement)(t,{text:f.title})}),null),savedTokenComponent:(0,r.createElement)((function(e){var n=e.emitResponse,a=e.eventRegistration.onPaymentSetup;(0,r.useEffect)((function(){return a((0,t.Z)(s().mark((function t(){var r;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,(0,c.startTransaction)("peachpay_stripe_card");case 3:if(!(r=t.sent).error&&r.result){t.next=6;break}throw r.error;case 6:return t.abrupt("return",{type:n.responseTypes.SUCCESS,meta:{paymentMethodData:{peachpay_transaction_id:r.result,"wc-peachpay_stripe_card-payment-token":e.token}}});case 9:return t.prev=9,t.t0=t.catch(0),t.abrupt("return",{type:n.responseTypes.ERROR,message:t.t0.message});case 12:case"end":return t.stop()}}),t,null,[[0,9]])}))))}),[e,a])}),null),name:"peachpay_stripe_card",supports:{features:f.supports,showSavedCards:!f.currency_fallback_required,showSaveOption:!f.currency_fallback_required}})})).catch((function(e){throw e}))}()}();
//# sourceMappingURL=peachpay_stripe_card_blocks.js.map